#!/bin/bash

# This script performs a single analysis using cppcheck
# It is used by the 'make test' target in the buildsystems
# Usually you should use 'ctest -C cppcheck' rather than calling this script directly
#
# Parameters: $1 = Application binary
#             $2 = Source file to process
#             $3..$N = include path parameters (-I dir1 -I dir2 ...)

cppcheck_cmd=$1
source_file=$2
shift 2

tmpfil=`mktemp`
$cppcheck_cmd $@ --force --enable=all --suppress=unusedFunction $source_file &> $tmpfil

declare -a ignorere
ignorere=(\\[.*/threads/Event.h.*\\]:.*CEventGroup.*not.explicit
          \\[.*/utils/Variant.h.*\\]:.*CVariant.*not.explicit
          \\[.*win/ThreadLocal.h.*\\]:.*Class.ThreadLocal.is.not.safe
          \\[.*/AEChannelInfo.h.*\\]:.*CAEChannelInfo.*not.explicit.
          \\[.*/BaseEvent.h.*\\]:.*Unused.private.*CBaseEvent::VariantToLocalizedString
          \\[.*/GUITexture.h.*\\]:.*CAspectRatio.*not.explicit
          \\[.*/ActiveAEDSPMode.cpp.*\\]:.*CActiveAEDSPMode::m_critSection.*not.assigned.*operator
          \\[.*/GUICallback.h.*\\]:.*C-style.pointer.casting
          \\[.*/XbtFile.h.*\\]:.*Unused.private.*CXbtFile::GetFile
          \\[.*/AutorunMediaJob.h.*\\]:.*Unused.private.*CAutorunMediaJob::GetWindowString
          \\[.*threads/Thread.h.*\\]:.*Unused.private.*CThread::SetSignalHandlers
          \\[.*/ThreadMessage.h.*\\]:.*Member.variable.*not.initialized
          \\[.*/Observer.cpp.*\\]:.*Member.variable.*Observable::m_obsCritSection.*not.assigned
          \\[.*/PerformanceSample.cpp.*\\]:.*tmDummy
          \\[.*/AEEncoderFFmpeg.h.*\\]:.*Unused.private.*CAEEncoderFFmpeg::BuildChannelLayout
          \\[.*/ExternalPlayer.h.*\\]:.*Unused.private.*CExternalPlayer::GetCustomRegexpReplacers
          \\[.*/VideoPlayerCodec.h.*\\]:.*Unused.private.*VideoPlayerCodec::GetPassthroughStreamType
          \\[.*/NFSDirectory.h.*\\]:.*Unused.private.*CNFSDirectory::GetServerList
          \\[.*/NFSDirectory.h.*\\]:.*Unused.private.*CNFSDirectory::ResolveSymlink
          \\[.*/NFSDirectory.h.*\\]:.*Unused.private.*CNFSDirectory::GetDirectoryFromExportList
          \\[.*/udf25.cpp.*\\]:.*Variable..directory_base..is.not.assigned
          \\[.*/udf25.cpp.*\\]:.*Variable..Anchor_base..is.not.assigned
          \\[.*/udf25.cpp.*\\]:.*Variable..LogBlock_base..is.not.assigned
          \\[.*/MusicDatabaseDirectory/DirectoryNodeGrouped.h.*\\]:.*Unused.private.*CDirectoryNodeGrouped::GetContentType
          \\[.*/ProfilesOperations.cpp.*\\]:.*Condition.*is.always.true
          \\[.*/GUIDialogVisualisationPresetList.h.*\\]:.*Unused.private.*CGUIDialogVisualisationPresetList::SetVisualisation
          \\[.*/NetworkServices.h.*\\]:.*Unused.private.*CNetworkServices::ValidatePort
          \\[.*/TCPServer.cpp.*\\]:.*CTCPClient::m_critSection.*not.assigned.*CTCPClient::operator=
          \\[.*/WakeOnAccess.h.*\\]:.*Unused.private.*CWakeOnAccess::LoadFromXML
          \\[.*/WakeOnAccess.h.*\\]:.*Unused.private.*CWakeOnAccess::SaveMACDiscoveryResult
          \\[.*/AirPlayServer.cpp.*\\]:.*Obsolete.function..asctime
          \\[.*/GUIDialogLockSettings.h.*\\]:.*Unused.private.*CGUIDialogLockSettings::setDetailSettingsEnabled
          \\[.*GUIDialogLockSettings.h.*\\]:.*Unused.private.*CGUIDialogLockSettings::setLockCodeLabel
          \\[.*/PVRTimers.cpp.*\\]:.*scope.*bStateChanged.*reduced
          \\[.*/GUIFixedListContainer.h.*\\].*Unused.private.*CGUIFixedListContainer::GetCursorRange
          \\[.*/SettingDependency.h.*\\]:.*Unused.private.*CSettingDependencyCondition::setOperator
          \\[.*/SettingDependency.h.*\\]:.*Unused.private.*CSettingDependencyCondition::setTarget
          \\[.*/SettingDependency.h.*\\]:.*Unused.private.*CSettingDependency::setType
          \\[.*/AddonInstaller.h.*\\]:.*Unused.private.*CAddonUnInstallJob::ClearFavourites
          \\[.*/FFmpegImage.h.*\\]:.*Unused.private.*CFFmpegImage::CleanupLocalOutputBuffer
          \\[.*/FFmpegImage.h.*\\]:.*Unused.private.*CFFmpegImage::EncodeFFmpegFrame
          \\[.*\\]:.*Obsolete.function..alloca..called
          \\[.*\\]:.*Using.memset.*contains.a.floating.point
          \\[.*\\]:.*Skipping.configuration
          \\[.*\\]:.*error..syntax.error
          \\[\\*\\]:)

nmatch=`cat $tmpfil | grep "\[.*\]" | wc -l`
for RE in ${ignorere[*]}
do
  echo "RE=$RE"
  nign=`cat $tmpfil | grep "$RE" | wc -l`
  echo "ignoring $nign"
  let "nmatch=$nmatch-$nign"
done
cat $tmpfil
rm $tmpfil
test $nmatch -eq 0 || exit 1
