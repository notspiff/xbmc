#!/bin/bash

# This script performs a single analysis using cppcheck
# It is used by the 'make test' target in the buildsystems
# Usually you should use 'ctest -C cppcheck' rather than calling this script directly
#
# Parameters: $1 = Application binary
#             $2 = Source file to process
#             $3..$N = include path parameters (-I dir1 -I dir2 ...)

cppcheck_cmd=$1
source_file=$2
shift 2

tmpfil=`mktemp`
$cppcheck_cmd $@ --force --enable=all --suppress=unusedFunction $source_file &> $tmpfil

declare -a ignorere
ignorere=(\\[.*/threads/Event.h.*\\]:.*CEventGroup.*not.explicit
          \\[.*/utils/Variant.h.*\\]:.*CVariant.*not.explicit
          \\[.*\\]:.*Skipping.configuration.*
          \\[.*win/ThreadLocal.h.*\\]:.*Class.ThreadLocal.is.not.safe
          \\[.*/AEChannelInfo.h.*\\]:.*CAEChannelInfo.*not.explicit.
          \\[\\*\\]:)


nmatch=`cat $tmpfil | grep "\[.*\]" | wc -l`
for RE in ${ignorere[*]}
do
  echo "RE=$RE"
  nign=`cat $tmpfil | grep "$RE" | wc -l`
  echo "ignoring $nign"
  let "nmatch=$nmatch-$nign"
done
cat $tmpfil
rm $tmpfil
test $nmatch -eq 0 || exit 1
